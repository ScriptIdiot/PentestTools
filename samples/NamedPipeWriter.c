#include <windows.h>
#include <stdio.h>



int main() {
	// Create named pipe: this will get patched in CNA
	HANDLE hPipe = CreateNamedPipeA(
		"\\\\.\\pipe\\testpipe",
		PIPE_ACCESS_DUPLEX,
		(PIPE_TYPE_MESSAGE | PIPE_READMODE_MESSAGE | PIPE_WAIT),
		1,
		0x1000,
		0x1000,
		0,
		NULL);

	if (hPipe == INVALID_HANDLE_VALUE) {
		return 1;
	}

	// Wait for beacon to connect
	while (!ConnectNamedPipe(hPipe, 0) && GetLastError() != ERROR_PIPE_CONNECTED);

	// send output
	char message[] = "[+] Hello from rDLL (via named pipe)!";
	DWORD dwBytesWritten = 0;
	WriteFile(hPipe, message, strlen(message), &dwBytesWritten, 0);
	FlushFileBuffers(hPipe);

	// cleanup
	DisconnectNamedPipe(hPipe);
	CloseHandle(hPipe);
	return 0;
}
